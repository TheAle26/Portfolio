{% extends "orders/base.html" %}
{% load crispy_forms_tags %}

{% block title %}Gestionar Inventario{% endblock %}

{% block content %}
<div class="container mt-4">

    <h1 class="h5 mb-3">Gestionar Inventario - {{ user.farmacia.nombre }}</h1>
        

    <div class="mb-3">
        <a href="{% url 'farmacia_panel' %}" class="btn btn-secondary">Volver al panel</a>
        <a href="{% url 'farmacia_pedidos' %}" class="btn btn-info">Pedidos Entrantes</a>
    </div>

    <!-- Card: Agregar Medicamento -->
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex align-items-center">
            Agregar Medicamento al Inventario
        </div>
        <div class="card-body">
            {% if add_form.fields.medicamento.disabled %}
                <div class="alert alert-info mb-0">Ya tienes todos los medicamentos disponibles registrados en tu stock.</div>
            {% else %}
                <form method="post" action="{% url 'gestionar_inventario' %}" class="row g-1">
                    {% csrf_token %}
                    {{ add_form|crispy }}
                    <div class="col-md-3 d-grid">
                        <button type="submit" class="btn btn-primary" >Agregar al Stock</button>
                    </div>
                </form>
            {% endif %}
        </div>
    </div>

    <!-- Card: Agregar Medicamento -->
    <div class="card shadow-sm">
        <div class="card-header d-flex align-items-center">
            Inventario
        </div>
        <div class="card-body">
        {% if stock_items %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0" id="tabla-inventario">
                    <thead class="table-light sticky-top shadow-sm">
                        <tr>
                            <th>Medicamento</th>
                            <th>Concentración</th>
                            <th class="text-center">Precio ($)</th>
                            <th class="text-center">Stock</th>
                            <th class="text-end"></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in stock_items %}
                        <tr>
                            <td>{{ item.medicamento.nombre_comercial }}</td>
                            <td>{{ item.medicamento.concentracion }}</td>
                            <form method="post" action="{% url 'editar_stock' item.id %}" class="d-inline">
                                {% csrf_token %}
                                <!--Precio-->
                                <td class="text-end" style="width:180px">
                                    <input type="number" step="0.01" name="precio" value="{{ edit_form.precio.value|default:item.precio|stringformat:'.2f' }}"
                                        class="form-control form-control-sm {% if editing_item_id == item.id and edit_form.precio.errors %}is-invalid{% endif %}"
                                        min="0.01" required id="id_precio_{{ item.id }}">
                                    {% if editing_item_id == item.id %}
                                        {% for error in edit_form.precio.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                </td>
                                <!--Stock-->
                                <td class="text-center" style="width:120px;">
                                    <div class="input-group input-group-sm justify-content-center" >
                                        <input type="number" name="stock_actual" value="{{ edit_form.stock_actual.value|default:item.stock_actual }}"
                                        class="form-control form-control-sm text-center {% if editing_item_id == item.id and edit_form.stock_actual.errors %}is-invalid{% endif %}"
                                        min="0" required id="id_stock_actual_{{ item.id }}">
                                    {% if editing_item_id == item.id %}
                                        {% for error in edit_form.stock_actual.errors %}
                                            <div class="invalid-feedback d-block">{{ error }}</div>
                                        {% endfor %}
                                    {% endif %}
                                    </div>
                                    
                                </td>
                                <td class="text-end" style="width:140px">
                                    <button type="submit" class="btn btn-info btn-sm ">Guardar</button>
                                </td>
                            </form>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="alert alert-info mb-0">Aún no has agregado medicamentos a tu inventario.</div>
        {% endif %}
</div>

<script>
    document.title = document.title + " | Inventario Farmacia";
</script>

{% endblock %}