{% extends 'tracking/base.html' %}
{% load i18n %}

{% block title %}{% trans "Fleet Dashboard" %}{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        .dashboard-wrapper {
            display: flex;
            height: calc(100vh - 56px);
            width: 100%;
            overflow: hidden;
        }

        #map { 
            flex: 1; 
            height: 100%; 
            z-index: 1;
        }

        .sidebar-list {
            width: 300px;
            height: 100%;
            background-color: white;
            border-left: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            box-shadow: -2px 0 5px rgba(0,0,0,0.05);
            z-index: 2;
        }

        /* --- ESTILO DE ETIQUETA MEJORADO (FONDO BLANCO) --- */
        .leaflet-tooltip.device-label {
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #333;
            color: #000;
            font-weight: bold;
            font-size: 11px;
            padding: 2px 5px;
            border-radius: 4px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.3);
        }
        /* Quitamos la flechita del tooltip para que quede más limpio */
        .leaflet-tooltip-top:before, 
        .leaflet-tooltip-bottom:before, 
        .leaflet-tooltip-left:before, 
        .leaflet-tooltip-right:before {
            display: none; 
        }

        @media (max-width: 768px) {
            .dashboard-wrapper { flex-direction: column; }
            .sidebar-list { width: 100%; height: 40%; }
        }
    </style>
{% endblock %}

{% block main_container %}
    <div class="dashboard-wrapper">
        <div id="map" style="height: 650px; border-radius: 12px; z-index: 1;" class="shadow-sm border"></div>

        <div class="sidebar-list">
            <div class="p-3 bg-light border-bottom">
                <h6 class="mb-0 text-uppercase text-muted fw-bold">{% trans "Fleet Status" %}</h6>
            </div>
            
            {% if devices %}
                {% for device in devices %}
                    <div class="d-block p-3 border-bottom hover-bg-light">
                       
                       <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold text-dark">
                                <i class="fa-solid fa-truck-moving me-2 text-primary"></i>
                                {{ device.name }}
                            </span>
                            {% if device.is_online %}
                                <span class="badge bg-success rounded-pill" style="font-size: 0.6rem;">ON</span>
                            {% else %}
                                <span class="badge bg-secondary rounded-pill" style="font-size: 0.6rem;">OFF</span>
                            {% endif %}
                       </div>

                       <div class="d-flex gap-2">
                           
                            <button onclick="focusDevice({{ device.id }})" class="btn btn-sm btn-outline-primary flex-fill" title="Centrar en Mapa">
                                <i class="fa-solid fa-crosshairs me-1"></i> Centrar
                            </button>

                            <a href="{% url 'tracking_device_map' device.id %}" class="btn btn-sm btn-primary flex-fill" title="Ver Telemetría">
                                Detalles <i class="fa-solid fa-arrow-right ms-1"></i>
                            </a>
                       </div>

                    </div>
                {% endfor %}
            {% else %}
                <div class="p-4 text-center text-muted">
                    {% trans "No devices assigned." %}
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // 1. Inicializar Mapa
        var map = L.map('map').setView([-34.9214, -57.9545], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap'
        }).addTo(map);

        var fleetMarkers = {};
        var featureGroup = L.featureGroup().addTo(map);

        function createIcon(isOnline) {
            var color = isOnline ? '#2ecc71' : '#95a5a6'; 
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style='background-color:${color}; width: 14px; height: 14px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5);'></div>`,
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
        }

        // --- FUNCIÓN ANTI-SUPERPOSICIÓN --
        // Si varios camiones tienen la misma lat/lon exacta, los separa visualmente un poquito
        function addJitter(lat, lon) {
            
            return [
                lat + (Math.random() - 0.5) * 0.0005, 
                lon + (Math.random() - 0.5) * 0.0005
            ];
        }

        function focusDevice(id) {
            var marker = fleetMarkers[id];

            if (marker) {

                var latLng = marker.getLatLng();
                map.flyTo(latLng, 16, {
                    animate: true,
                    duration: 1.5 
                });
                marker.openPopup();
            } else {
                alert("Este vehículo no tiene ubicación reciente en el mapa.");
            }
        }
        function updateFleet() {
            fetch("{% url 'api_telemetry_all' %}")
                .then(response => response.json())
                .then(data => {
                    var devices = data.devices;

                    devices.forEach(device => {
                        // USAMOS LAS VARIABLES CORRECTAS DEL JSON
                        var id = device.device_id;
                        var name = device.device_name;
                        var lat = device.lat;
                        var lon = device.lon;
                        var ign = device.ignition;

                        var newLatLng = new L.LatLng(lat, lon);

                        // A. ACTUALIZAR EXISTENTE
                        if (fleetMarkers[id]) {
                            fleetMarkers[id].setLatLng(newLatLng);
                            fleetMarkers[id].setIcon(createIcon(ign));
                        } 
                        // B. CREAR NUEVO
                        else {
                            var marker = L.marker(newLatLng, {icon: createIcon(ign)})
                                .addTo(map);
                            
                            marker.bindTooltip(name, {
                                permanent: true,
                                direction: 'top', 
                                className: 'device-label',
                                offset: [0, -10],
                                opacity: 1
                            });

                            marker.bindPopup(`
                                <div class="text-center">
                                    <strong>${name}</strong><br>
                                    <span class="badge ${ign ? 'bg-success' : 'bg-secondary'}">${ign ? 'ON' : 'OFF'}</span><br>
                                    <a href="/tracking/map/${id}/" class="btn btn-sm btn-primary mt-2">Ver Detalles</a>
                                </div>
                            `);

                            fleetMarkers[id] = marker;
                            featureGroup.addLayer(marker);
                        }
                    });

                    // Auto-zoom la primera vez
                    if (devices.length > 0 && !window.zoomedOnce) {
                        try {
                            map.fitBounds(featureGroup.getBounds(), {padding: [50, 50]});
                            window.zoomedOnce = true;
                        } catch(e) { console.log("Esperando coordenadas..."); }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        updateFleet();
        setInterval(updateFleet, 5000);
    </script>
{% endblock %}